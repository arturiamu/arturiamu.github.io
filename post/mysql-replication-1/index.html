<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='详细介绍MySQL复制相关的内容，包括基本概念、复制原理、如何配置不同类型的复制(传统复制)等'>
<meta name="keywords" content="木林彪, arturiamu, 博客, 木林彪的个人博客, MySQL, MySQL复制"><title>深入MySQL复制(一)</title>

<link rel='canonical' href='https://arturiamu.github.io/post/mysql-replication-1/'>

<link rel="stylesheet" href="/scss/style.min.5e3814b8c20dd362819d8f0b1c0554df211090883babaeea35913b6b16121b26.css"><meta property='og:title' content='深入MySQL复制(一)'>
<meta property='og:description' content='详细介绍MySQL复制相关的内容，包括基本概念、复制原理、如何配置不同类型的复制(传统复制)等'>
<meta property='og:url' content='https://arturiamu.github.io/post/mysql-replication-1/'>
<meta property='og:site_name' content='木林彪的个人博客'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='MySQL' /><meta property='article:published_time' content='2023-09-18T14:51:23&#43;08:00'/><meta property='article:modified_time' content='2023-09-18T14:51:23&#43;08:00'/>
<meta name="twitter:site" content="@ArturiaMu">
    <meta name="twitter:creator" content="@ArturiaMu"><meta name="twitter:title" content="深入MySQL复制(一)">
<meta name="twitter:description" content="详细介绍MySQL复制相关的内容，包括基本概念、复制原理、如何配置不同类型的复制(传统复制)等">
    <link rel="shortcut icon" href="/favicon.ico" />

<script async src="https://www.googletagmanager.com/gtag/js?id=G-JJG6TYWNYX"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-JJG6TYWNYX', { 'anonymize_ip': false });
}
</script>
<style>
    :root {
         
        --sys-font-family: "HarmonyOS_Sans_SC_Medium", Georgia, -apple-system, 'Nimbus Roman No9 L', 'PingFang SC', 'Hiragino Sans GB', 'Noto Serif SC', 'Microsoft Yahei', 'WenQuanYi Micro Hei', 'ST Heiti', sans-serif;
        --code-font-family: "JetBrainsMono Regular", Menlo, Monaco, Consolas, "Courier New";
        --article-font-family: "HarmonyOS_Sans_SC_Medium", var(--base-font-family);
    }
</style>

<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://img.shimoko.com/fonts/font.css";
        customFont.type = "text/css";
        customFont.rel = "stylesheet";
        document.head.appendChild(customFont);
    }());
</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar1_hu67b097db30250ef6a2ed6dd217c7d0a7_22735_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">❤️</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">木林彪的个人博客</a></h1>
            <h2 class="site-description">~Coding my life~</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/arturiamu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:arturiamumu@gmail.com'
                        target="_blank"
                        title="Gmail"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-gmail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
    <path d="M16 20h3a1 1 0 0 0 1 -1v-14a1 1 0 0 0 -1 -1h-3v16z" />
    <path d="M5 20h3v-16h-3a1 1 0 0 0 -1 1v14a1 1 0 0 0 1 1z" />
    <path d="M16 4l-4 4l-4 -4" />
    <path d="M4 6.5l8 7.5l8 -7.5" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>链接</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/message/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-message-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M8 9h8" />
  <path d="M8 13h6" />
  <path d="M9 18h-3a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-3l-3 3l-3 -3z" />
</svg>



                
                <span>留言</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://arturiamu.github.io/" selected>中文</option>
                        
                            <option value="https://arturiamu.github.io/en/" >English</option>
                        
                            <option value="https://arturiamu.github.io/ja/" >日本</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#复制的基本概念和原理">复制的基本概念和原理</a></li>
    <li><a href="#复制的好处">复制的好处</a></li>
    <li><a href="#复制分类和它们的特性">复制分类和它们的特性</a>
      <ol>
        <li><a href="#同步复制">同步复制</a></li>
        <li><a href="#半同步复制">半同步复制</a></li>
        <li><a href="#异步复制">异步复制</a></li>
        <li><a href="#延迟复制">延迟复制</a></li>
      </ol>
    </li>
    <li><a href="#配置一主一从">配置一主一从</a>
      <ol>
        <li><a href="#一主一从">一主一从</a></li>
        <li><a href="#将slave恢复到master指定的坐标">将slave恢复到master指定的坐标</a>
          <ol>
            <li><a href="#获取master-binlog的坐标">获取master binlog的坐标</a></li>
            <li><a href="#备份master数据到slave上">备份master数据到slave上</a></li>
          </ol>
        </li>
        <li><a href="#slave开启复制">slave开启复制</a></li>
        <li><a href="#查看slave的信息">查看slave的信息</a>
          <ol>
            <li><a href="#masterinfo">master.info</a></li>
            <li><a href="#relay-loginfo">relay-log.info</a></li>
            <li><a href="#show-slave-status">show slave status</a></li>
            <li><a href="#slave信息汇总">slave信息汇总</a></li>
          </ol>
        </li>
        <li><a href="#mysql复制如何实现断开重连">MySQL复制如何实现断开重连</a></li>
        <li><a href="#一些变量">一些变量</a></li>
      </ol>
    </li>
    <li><a href="#一主多从">一主多从</a>
      <ol>
        <li><a href="#向现有主从结构中添加slave">向现有主从结构中添加slave</a></li>
        <li><a href="#配置一主多从从中有从">配置一主多从(从中有从)</a></li>
      </ol>
    </li>
    <li><a href="#mysql复制中一些常用操作">MySQL复制中一些常用操作</a>
      <ol>
        <li><a href="#筛选要复制的库和表">筛选要复制的库和表</a></li>
        <li><a href="#reset-slave和reset-master">reset slave和reset master</a></li>
        <li><a href="#show-slave-hosts">show slave hosts</a></li>
        <li><a href="#多线程复制">多线程复制</a>
          <ol>
            <li><a href="#多线程复制带来的不一致问题">多线程复制带来的不一致问题</a></li>
            <li><a href="#多线程复制切换回单线程复制">多线程复制切换回单线程复制</a></li>
          </ol>
        </li>
        <li><a href="#slave升级为master的大致操作">slave升级为master的大致操作</a></li>
        <li><a href="#指定不复制到slave上的语句">指定不复制到slave上的语句</a></li>
        <li><a href="#主从高延迟的解决思路">主从高延迟的解决思路</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
            
                <section class="widget tagCloud">
    <div class="widget-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4" />
  <circle cx="9" cy="9" r="2" />
</svg>



    </div>
    <h2 class="widget-title section-title">标签云</h2>

    <div class="tagCloud-tags">
        
            <a href="/tags/linux/" class="font_size_4">
                linux
            </a>
        
            <a href="/tags/bash/" class="font_size_3">
                bash
            </a>
        
            <a href="/tags/mysql/" class="font_size_3">
                mysql
            </a>
        
            <a href="/tags/python/" class="font_size_3">
                python
            </a>
        
            <a href="/tags/bug/" class="font_size_2">
                bug
            </a>
        
            <a href="/tags/golang/" class="font_size_2">
                golang
            </a>
        
            <a href="/tags/blog/" class="font_size_1">
                blog
            </a>
        
            <a href="/tags/docker/" class="font_size_1">
                docker
            </a>
        
            <a href="/tags/gin/" class="font_size_1">
                gin
            </a>
        
            <a href="/tags/git/" class="font_size_1">
                git
            </a>
        
    </div>
</section>
            
        
        <div style="height: 30%;width: 30%">
            <script type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=4gAmsOskyL921TwxZGdrq3NbkFu-hJm8dDfoHJsn25Q"></script>
        </div>
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/archives/database/" >
                数据库
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/mysql-replication-1/">深入MySQL复制(一)</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            详细介绍MySQL复制相关的内容，包括基本概念、复制原理、如何配置不同类型的复制(传统复制)等
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2023-09-18 14:51:23 CST</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 46 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><strong>本文转载自 <a class="link" href="https://www.cnblogs.com/f-ck-need-u/p/9155003.html"  target="_blank" rel="noopener"
    >深入MySQL复制(一)</a></strong></p>
<p>本文非常详细地介绍MySQL复制相关的内容，包括基本概念、复制原理、如何配置不同类型的复制(传统复制)等等</p>
<p>本文是MySQL Replication的基础，但却非常重要。对于MySQL复制，如何搭建它不是重点(因为简单，网上资源非常多)，如何维护它才是重点(网上资源不集中)。
以下几个知识点是掌握MySQL复制所必备的：</p>
<ol>
<li>
<p>复制的原理</p>
</li>
<li>
<p>将master上已存在的数据恢复到slave上作为基准数据</p>
</li>
<li>
<p>获取<strong>正确的</strong>binlog坐标</p>
</li>
<li>
<p><strong>深入理解</strong><code>show slave status</code>中的一些状态信息</p>
</li>
<li>
<p>本文对以上内容都做了非常详细的说明。希望对各位初学、深入MySQL复制有所帮助。</p>
</li>
</ol>
<p>mysql replication官方手册：https://dev.mysql.com/doc/refman/5.7/en/replication.html。</p>
<h2 id="复制的基本概念和原理">复制的基本概念和原理</h2>
<p>mysql复制是指从一个mysql服务器(MASTER)将数据通过日志的方式经过网络传送到另一台或多台mysql服务器(SLAVE)，然后在slave上重放(replay或redo)传送过来的日志，以达到和master数据同步的目的。</p>
<p>它的工作原理很简单。首先<strong>确保master数据库上开启了二进制日志，这是复制的前提</strong>。</p>
<ul>
<li>在slave准备开始复制时，首先<strong>要执行<code>change master to</code>语句设置连接到master服务器的连接参数,</strong> 在执行该语句的时候要提供一些信息，包括如何连接和要从哪复制binlog，这些信息在连接的时候会记录到slave的datadir下的master.info文件中，以后再连接master的时候将不用再提供这新信息而是直接读取该文件进行连接。</li>
<li>在slave上有两种线程，分别是IO线程和SQL线程。
<ul>
<li>IO线程用于连接master，监控和接受master的binlog。当启动IO线程成功连接master时，master会同时启动一个dump线程，该线程将slave请求要复制的binlog给dump出来，之后IO线程负责监控并接收master上dump出来的二进制日志，当master上binlog有变化的时候，IO线程就将其复制过来并写入到自己的中继日志(relay log)文件中。</li>
<li>slave上的另一个线程SQL线程用于监控、读取并重放relay log中的日志，将数据写入到自己的数据库中。如下图所示。</li>
</ul>
</li>
</ul>
<p>站在slave的角度上看，过程如下：</p>
<p><img src="/post/mysql-replication-1/img_1.png"
	width="408"
	height="278"
	srcset="/post/mysql-replication-1/img_1_hue5e759dcb878c2c5710369accbb121f3_64663_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_1_hue5e759dcb878c2c5710369accbb121f3_64663_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="146"
		data-flex-basis="352px"
	
></p>
<p>站在master的角度上看，过程如下(默认的异步复制模式，前提是设置了<code>sync_binlog=1</code>，否则binlog刷盘时间由操作系统决定)：</p>
<p><img src="/post/mysql-replication-1/img_2.png"
	width="652"
	height="481"
	srcset="/post/mysql-replication-1/img_2_hu1e3b060e6bcf83cca3f89a40eaece3e6_69917_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_2_hu1e3b060e6bcf83cca3f89a40eaece3e6_69917_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="135"
		data-flex-basis="325px"
	
></p>
<p>所以，可以认为复制大致有三个步骤：</p>
<ul>
<li>数据修改写入master数据库的binlog中。</li>
<li>slave的IO线程复制这些变动的binlog到自己的relay log中。</li>
<li>slave的SQL线程读取并重新应用relay log到自己的数据库上，让其和master数据库保持一致。</li>
</ul>
<p>从复制的机制上可以知道，在复制进行前，slave上必须具有master上部分完整内容作为复制基准数据。例如，master上有数据库A，二进制日志已经写到了pos1位置，那么在复制进行前，slave上必须要有数据库A，且如果要从pos1位置开始复制的话，还必须有和master上pos1之前完全一致的数据。如果不满足这样的一致性条件，那么在replay中继日志的时候将不知道如何进行应用而导致数据混乱。<strong>也就是说，复制是基于binlog的position进行的，复制之前必须保证position一致。</strong>(注：这是传统的复制方式所要求的)</p>
<p>可以选择对哪些数据库甚至数据库中的哪些表进行复制。<strong>默认情况下，MySQL的复制是异步的。slave可以不用一直连着master，即使中间断开了也能从断开的position处继续进行复制。</strong></p>
<p>MySQL 5.6对比MySQL 5.5在复制上进行了很大的改进，主要包括支持GTID(Global Transaction ID,全局事务ID)复制和多SQL线程并行重放。GTID的复制方式和传统的复制方式不一样，通过全局事务ID，它不要求复制前slave有基准数据，也不要求binlog的position一致。</p>
<p>MySQL 5.7.17则提出了组复制(MySQL Group Replication,MGR)的概念。像数据库这样的产品，必须要尽可能完美地设计一致性问题，特别是在集群、分布式环境下。Galera就是一个MySQL集群产品，它支持多主模型(多个master)，但是当MySQL 5.7.17引入了MGR功能后，Galera的优势不再明显，甚至MGR可以取而代之。MGR为MySQL集群中多主复制的很多问题提供了很好的方案，可谓是一项革命性的功能。</p>
<p>复制和二进制日志息息相关，所以学习本章必须先有二进制日志的相关知识。</p>
<h2 id="复制的好处">复制的好处</h2>
<p>围绕下面的拓扑图来分析：</p>
<p><img src="/post/mysql-replication-1/img_3.png"
	width="507"
	height="467"
	srcset="/post/mysql-replication-1/img_3_hu495964904e55c678384b09e2655d2267_38770_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_3_hu495964904e55c678384b09e2655d2267_38770_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="260px"
	
></p>
<p>主要有以下几点好处：</p>
<p><strong>1.提供了读写分离的能力。</strong></p>
<p>replication让所有的slave都和master保持数据一致，因此外界客户端可以从各个slave中读取数据，而写数据则从master上操作。也就是实现了读写分离。</p>
<p>需要注意的是，为了保证数据一致性，<strong>写操作必须在master上进行。</strong></p>
<p>通常说到读写分离这个词，立刻就能意识到它会分散压力、提高性能。</p>
<p><strong>2.为MySQL服务器提供了良好的伸缩(scale-out)能力。</strong></p>
<p>由于各个slave服务器上只提供数据检索而没有写操作，因此&quot;随意地&quot;增加slave服务器数量来提升整个MySQL群的性能，而不会对当前业务产生任何影响。</p>
<p>之所以&quot;随意地&quot;要加上双引号，是因为每个slave都要和master建立连接，传输数据。如果slave数量巨多，master的压力就会增大，网络带宽的压力也会增大。</p>
<p><strong>3.数据库备份时，对业务影响降到最低。</strong></p>
<p>由于MySQL服务器群中所有数据都是一致的(至少几乎是一致的)，所以在需要备份数据库的时候可以任意停止某一台slave的复制功能(甚至停止整个mysql服务)，然后从这台主机上进行备份，这样几乎不会影响整个业务(除非只有一台slave，但既然只有一台slave，说明业务压力并不大，短期内将这个压力分配给master也不会有什么影响)。</p>
<p><strong>4.能提升数据的安全性。</strong></p>
<p>这是显然的，任意一台mysql服务器断开，都不会丢失数据。即使是master宕机，也只是丢失了那部分还没有传送的数据(异步复制时才会丢失这部分数据)。</p>
<p><strong>5.数据分析不再影响业务。</strong></p>
<p>需要进行数据分析的时候，直接划分一台或多台slave出来专门用于数据分析。这样OLTP和OLAP可以共存，且几乎不会影响业务处理性能。</p>
<h2 id="复制分类和它们的特性">复制分类和它们的特性</h2>
<p>MySQL支持两种不同的复制方法：传统的复制方式和GTID复制。MySQL 5.7.17之后还支持组复制(MGR)。</p>
<ul>
<li>传统的复制方法要求复制之前，slave上必须有基准数据，且binlog的position一致。</li>
<li>GTID复制方法不要求基准数据和binlog的position一致性。GTID复制时，master上只要一提交，就会立即应用到slave上。这极大地简化了复制的复杂性，且更好地保证master上和各slave上的数据一致性。</li>
</ul>
<p>从数据同步方式的角度考虑，MySQL支持4种不同的同步方式：同步(synchronous)、半同步(semisynchronous)、异步(asynchronous)、延迟(delayed)。所以对于复制来说，就分为同步复制、半同步复制、异步复制和延迟复制。</p>
<h3 id="同步复制">同步复制</h3>
<p>客户端发送DDL/DML语句给master，master执行完毕后还需要<strong>等待所有的slave都写完了relay log才认为此次DDL/DML成功，然后才会返回成功信息给客户端。</strong> 同步复制的问题是master必须等待，所以延迟较大，在MySQL中不使用这种复制方式。</p>
<p><img src="/post/mysql-replication-1/img_4.png"
	width="519"
	height="378"
	srcset="/post/mysql-replication-1/img_4_hu3f02eb04ec51ceb03ef0c5c7f76dff27_37551_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_4_hu3f02eb04ec51ceb03ef0c5c7f76dff27_37551_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="137"
		data-flex-basis="329px"
	
></p>
<p>例如上图中描述的，只有3个slave全都写完relay log并返回ACK给master后，master才会判断此次DDL/DML成功。</p>
<h3 id="半同步复制">半同步复制</h3>
<p>客户端发送DDL/DML语句给master，master执行完毕后<strong>还要等待一个slave写完relay log并返回确认信息给master，master才认为此次DDL/DML语句是成功的，然后才会发送成功信息给客户端。</strong> 半同步复制只需等待一个slave的回应，且等待的超时时间可以设置，超时后会自动降级为异步复制，所以在局域网内(网络延迟很小)使用半同步复制是可行的。</p>
<p><img src="/post/mysql-replication-1/img_5.png"
	width="521"
	height="365"
	srcset="/post/mysql-replication-1/img_5_hudd2a5723d95ff1472c0785fab885d469_36598_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_5_hudd2a5723d95ff1472c0785fab885d469_36598_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="142"
		data-flex-basis="342px"
	
></p>
<p>例如上图中，只有第一个slave返回成功，master就判断此次DDL/DML成功，其他的slave无论复制进行到哪一个阶段都无关紧要。</p>
<h3 id="异步复制">异步复制</h3>
<p>客户端发送DDL/DML语句给master，<strong>master执行完毕立即返回成功信息给客户端，而不管slave是否已经开始复制。</strong> 这样的复制方式导致的问题是，当master写完了binlog，而slave还没有开始复制或者复制还没完成时，<strong>slave上和master上的数据暂时不一致，且此时master突然宕机，slave将会丢失一部分数据。如果此时把slave提升为新的master，那么整个数据库就永久丢失这部分数据。</strong></p>
<p><img src="/post/mysql-replication-1/img_6.png"
	width="515"
	height="330"
	srcset="/post/mysql-replication-1/img_6_hu1b8309f6ffd8173025b6c68481499655_34041_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_6_hu1b8309f6ffd8173025b6c68481499655_34041_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="156"
		data-flex-basis="374px"
	
></p>
<h3 id="延迟复制">延迟复制</h3>
<p>顾名思义，延迟复制就是故意让slave延迟一段时间再从master上进行复制。</p>
<h2 id="配置一主一从">配置一主一从</h2>
<p>此处先配置默认的异步复制模式。由于复制和binlog息息相关，如果对binlog还不熟悉，请先了解binlog。</p>
<p>mysql支持一主一从和一主多从。但是每个slave必须只能是一个master的从，否则从多个master接受二进制日志后重放将会导致数据混乱的问题。</p>
<p>以下是一主一从的结构图：</p>
<p><img src="/post/mysql-replication-1/img_7.png"
	width="336"
	height="365"
	srcset="/post/mysql-replication-1/img_7_hu58609a2925e5994633016c4e69e8bb2e_17672_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_7_hu58609a2925e5994633016c4e69e8bb2e_17672_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="92"
		data-flex-basis="220px"
	
></p>
<p>在开始传统的复制(非GTID复制)前，需要完成以下几个关键点，<strong>这几个关键点指导后续复制的所有步骤。</strong></p>
<ol>
<li>为master和slave设定不同的<code>server-id</code>，这是主从复制结构中非常关键的标识号。到了MySQL 5.7，似乎不设置server id就无法开启binlog。设置server id需要重启MySQL实例。</li>
<li>开启master的binlog。刚安装并初始化的MySQL默认未开启binlog，建议手动设置binlog且为其设定文件名，否则默认以主机名为基名时修改主机名后会找不到日志文件。</li>
<li>最好设置master上的变量<code>sync_binlog=1</code>(MySQL 5.7.7之后默认为1，之前的版本默认为0)，这样每写一次二进制日志都将其刷新到磁盘，让slave服务器可以尽快地复制。防止万一master的二进制日志还在缓存中就宕机时，slave无法复制这部分丢失的数据。</li>
<li>最好设置master上的redo log的刷盘变量<code>innodb_flush_log_at_trx_commit=1</code>(默认值为1)，这样每次提交事务都会立即将事务刷盘保证持久性和一致性。</li>
<li>在slave上开启中继日志relay log。这个是默认开启的，同样建议手动设置其文件名。</li>
<li>建议在master上专门创建一个用于复制的用户，它只需要有复制权限<code>replication slave</code>用来读取binlog。</li>
<li>确保slave上的数据和master上的数据在&quot;复制的起始position之前&quot;是完全一致的。如果master和slave上数据不一致，复制会失败。</li>
<li>记下master开始复制前binlog的position，因为在slave连接master时需要指定从master的哪个position开始复制。</li>
<li>考虑是否将slave设置为只读，也就是开启<code>read_only</code>选项。这种情况下，除了具有super权限(mysql 5.7.16还提供了<code>super_read_only</code>禁止super的写操作)和SQL线程能写数据库，其他用户都不能进行写操作。这种禁写对于slave来说，绝大多数场景都非常适合。</li>
</ol>
<h3 id="一主一从">一主一从</h3>
<p>一主一从是最简单的主从复制结构。本节实验环境如下：</p>
<p><img src="/post/mysql-replication-1/img_8.png"
	width="675"
	height="241"
	srcset="/post/mysql-replication-1/img_8_huc2ac1024c36693391cc8eaacf7c10867_11667_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_8_huc2ac1024c36693391cc8eaacf7c10867_11667_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="280"
		data-flex-basis="672px"
	
></p>
<p><strong>1、配置master和slave的配置文件。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">[mysqld]          # master</span>
</span></span><span class="line"><span class="cl"><span class="na">datadir</span><span class="o">=</span><span class="s">/data</span>
</span></span><span class="line"><span class="cl"><span class="na">socket</span><span class="o">=</span><span class="s">/data/mysql.sock</span>
</span></span><span class="line"><span class="cl"><span class="na">log-bin</span><span class="o">=</span><span class="s">master-bin</span>
</span></span><span class="line"><span class="cl"><span class="na">sync-binlog</span><span class="o">=</span><span class="s">1</span>
</span></span><span class="line"><span class="cl"><span class="na">server-id</span><span class="o">=</span><span class="s">100 </span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">[mysqld]       # slave</span>
</span></span><span class="line"><span class="cl"><span class="na">datadir</span><span class="o">=</span><span class="s">/data</span>
</span></span><span class="line"><span class="cl"><span class="na">socket</span><span class="o">=</span><span class="s">/data/mysql.sock</span>
</span></span><span class="line"><span class="cl"><span class="na">relay-log</span><span class="o">=</span><span class="s">slave-bin</span>
</span></span><span class="line"><span class="cl"><span class="na">server-id</span><span class="o">=</span><span class="s">111</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2、重启master和slave上的MySQL实例。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">service mysqld restart
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3、在master上创建复制专用的用户。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="s1">&#39;repl&#39;</span><span class="o">@</span><span class="s1">&#39;192.168.100.%&#39;</span><span class="w"> </span><span class="k">identified</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="s1">&#39;P@ssword1!&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">grant</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="n">SLAVE</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s1">&#39;repl&#39;</span><span class="o">@</span><span class="s1">&#39;192.168.100.%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4、将slave恢复到master上指定的坐标。</strong></p>
<p>这是备份恢复的内容，此处用一个小节来简述操作过程。</p>
<h3 id="将slave恢复到master指定的坐标">将slave恢复到master指定的坐标</h3>
<p>对于复制而言，有几种情况：</p>
<ul>
<li>待复制的master没有新增数据，例如新安装的mysql实例。这种情况下，可以跳过恢复这个过程。</li>
<li>待复制的master上已有数据。这时需要将这些已有数据也应用到slave上，并获取master上binlog当前的坐标。只有slave和master的数据能匹配上，slave重放relay log时才不会出错。</li>
</ul>
<p>第一种情况此处不赘述。第二种情况有几种方法，例如使用mysqldump、冷备份、xtrabackup等工具，这其中又需要考虑是MyISAM表还是InnoDB表。</p>
<p>在实验开始之前，首先在master上新增一些测试数据，以innodb和myisam的数值辅助表为例。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">DROP</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">backuptest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">backuptest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">USE</span><span class="w"> </span><span class="n">backuptest</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="err">创建</span><span class="n">myisam类型的数值辅助表和插入数据的存储过程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">num_isam</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MYISAM</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DROP</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">proc_num1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DELIMITER</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">proc_num1</span><span class="w"> </span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_isam</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_isam</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">dd</span><span class="p">:</span><span class="w"> </span><span class="n">WHILE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="k">DO</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_isam</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_isam</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="w"> </span><span class="n">dd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_isam</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rn</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_isam</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">$$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DELIMITER</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="err">创建</span><span class="n">innodb类型的数值辅助表和插入数据的存储过程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">num_innodb</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INNODB</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DROP</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">proc_num2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DELIMITER</span><span class="w"> </span><span class="err">$$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">PROCEDURE</span><span class="w"> </span><span class="n">proc_num2</span><span class="w"> </span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">DECLARE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_innodb</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_innodb</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">dd</span><span class="p">:</span><span class="w"> </span><span class="n">WHILE</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="k">DO</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_innodb</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_innodb</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="n">WHILE</span><span class="w"> </span><span class="n">dd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_innodb</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rn</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_innodb</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">$$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">DELIMITER</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="err">分别向两个数值辅助表中插入</span><span class="mi">100</span><span class="n">W条数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CALL</span><span class="w"> </span><span class="n">proc_num1</span><span class="w"> </span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CALL</span><span class="w"> </span><span class="n">proc_num2</span><span class="w"> </span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>所谓数值辅助表是只有一列的表，且这个字段的值全是数值，从1开始增长。例如上面的是从1到100W的数值辅助表。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">backuptest</span><span class="p">.</span><span class="n">num_isam</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">n</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="获取master-binlog的坐标">获取master binlog的坐标</h4>
<p><strong>如果master是全新的数据库实例，或者在此之前没有开启过binlog，那么它的坐标位置是position=4。</strong> 之所以是4而非0，是因为binlog的前4个记录单元是每个binlog文件的头部信息。</p>
<p>如果master已有数据，或者说master以前就开启了binlog并写过数据库，那么需要手动获取position。<strong>为了安全以及没有后续写操作，必须先锁表。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; flush tables with <span class="nb">read</span> lock<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，这次的<strong>锁表会导致写阻塞以及innodb的commit操作。</strong></p>
<p>然后查看binlog的坐标。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show master status<span class="p">;</span>   <span class="c1"># 为了排版，简化了输出结果</span>
</span></span><span class="line"><span class="cl">+-------------------+----------+--------------+--------+--------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> File              <span class="p">|</span> Position <span class="p">|</span> Binlog_Do_DB <span class="p">|</span> ...... <span class="p">|</span> ...... <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-------------------+----------+--------------+--------+--------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> master-bin.000001 <span class="p">|</span>      <span class="m">623</span> <span class="p">|</span>              <span class="p">|</span>        <span class="p">|</span>        <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-------------------+----------+--------------+--------+--------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>记住master-bin.000001和623。</p>
<h4 id="备份master数据到slave上">备份master数据到slave上</h4>
<p>下面给出3种备份方式以及对应slave的恢复方法。建议备份所有库到slave上，如果要筛选一部分数据库或表进行复制，应该在slave上筛选(筛选方式见后文筛选要复制的库和表)，而不应该在master的备份过程中指定。</p>
<ul>
<li><strong>方式一：冷备份直接cp。这种情况只适用于没有新写入操作。严谨一点，只适合拷贝完成前master不能有写入操作。</strong></li>
</ul>
<ol>
<li>如果要复制所有库，那么直接拷贝整个datadir。</li>
<li>如果要复制的是某个或某几个库，直接拷贝相关目录即可。但注意，这种冷备份的方式只适合MyISAM表和开启了innodb_file_per_table=ON的InnoDB表。如果没有开启该变量，innodb表使用公共表空间，无法直接冷备份。</li>
<li>如果要冷备份innodb表，最安全的方法是先关闭master上的mysql，而不是通过表锁。</li>
</ol>
<p>所以，<strong>如果没有涉及到innodb表，那么在锁表之后，可以直接冷拷贝。最后释放锁。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; flush tables with <span class="nb">read</span> lock<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; show master status<span class="p">;</span>   <span class="c1"># 为了排版，简化了输出结果</span>
</span></span><span class="line"><span class="cl">+-------------------+----------+--------------+--------+--------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> File              <span class="p">|</span> Position <span class="p">|</span> Binlog_Do_DB <span class="p">|</span> ...... <span class="p">|</span> ...... <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-------------------+----------+--------------+--------+--------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> master-bin.000001 <span class="p">|</span>      <span class="m">623</span> <span class="p">|</span>              <span class="p">|</span>        <span class="p">|</span>        <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-------------------+----------+--------------+--------+--------+
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; rsync -avz /data 192.168.100.150:/
</span></span><span class="line"><span class="cl">mysql&gt; unlock tables<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此处实验，假设要备份的是整个实例，因为<strong>涉及到了innodb表，所以建议关闭MySQL。</strong> 因为是冷备份，所以slave上也应该关闭MySQL。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># master和slave上都执行</span>
</span></span><span class="line"><span class="cl">shell&gt; mysqladmin -uroot -p shutdown 
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后将整个datadir拷贝到slave上(当然，有些文件是不用拷贝的，比如master上的binlog、mysql库等)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 将master的datadir(/data)拷贝到slave的datadir(/data)</span>
</span></span><span class="line"><span class="cl">shell&gt; rsync -avz /data 192.168.100.150:/
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要注意，在冷备份的时候，需要将备份到目标主机上的DATADIR/auto.conf删除，这个文件中记录的是mysql server的UUID，而master和slave的UUID必须不能一致。</p>
<p>然后重启master和slave。因为重启了master，所以binlog已经滚动了，不过这次不用再查看binlog坐标，因为重启造成的binlog日志移动不会影响slave。</p>
<ul>
<li><strong>方式二：使用mysqldump进行备份恢复。</strong></li>
</ul>
<p>这种方式简单的多，而且对于innodb表很适用，但是slave上恢复时速度慢，因为恢复时数据全是通过insert插入的。因为mysqldump可以进行定时点恢复甚至记住binlog的坐标，所以无需再手动获取binlog的坐标。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; mysqldump -uroot -p --all-databases --master-data<span class="o">=</span><span class="m">2</span> &gt;dump.db
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，<code>--master-data</code>选项将再dump.db中加入<code>change master to</code>相关的语句，值为2时，<code>change master to</code>语句是注释掉的，值为1或者没有提供值时，这些语句是直接激活的。同时，<code>--master-data</code>会锁定所有表(如果同时使用了<code>--single-transaction</code>，则不是锁所有表，详细内容请参见mysqldump)。</p>
<p>因此，可以直接从dump.db中获取到binlog的坐标。记住这个坐标。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># grep -i -m 1 &#39;change master to&#39; dump.db </span>
</span></span><span class="line"><span class="cl">-- CHANGE MASTER TO <span class="nv">MASTER_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;master-bin.000002&#39;</span>, <span class="nv">MASTER_LOG_POS</span><span class="o">=</span>154<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后将dump.db拷贝到slave上，使用mysql执行dump.db脚本即可。也可以直接在master上远程连接到slave上执行。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; mysql -uroot -p -h 192.168.100.150 -e <span class="s1">&#39;source dump.db&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>方式三：使用xtrabackup进行备份恢复。</strong></li>
</ul>
<p>这是三种方式中最佳的方式，安全性高、速度快。因为xtrabackup备份的时候会记录master的binlog的坐标，因此也无需手动获取binlog坐标。</p>
<p>xtrabackup详细的备份方法见：xtrabackup</p>
<p>注意：master和slave上都安装percona-xtrabackup。</p>
<p>以全备份为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">innobackupex -u root -p /backup
</span></span></code></pre></td></tr></table>
</div>
</div><p>备份完成后，在/backup下生成一个以时间为名称的目录。其内文件如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># ll /backup/2018-05-29_04-12-15</span>
</span></span><span class="line"><span class="cl">total <span class="m">77872</span>
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root root      <span class="m">489</span> May <span class="m">29</span> 04:12 backup-my.cnf
</span></span><span class="line"><span class="cl">drwxr-x--- <span class="m">2</span> root root     <span class="m">4096</span> May <span class="m">29</span> 04:12 backuptest
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root root     <span class="m">1560</span> May <span class="m">29</span> 04:12 ib_buffer_pool
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root root <span class="m">79691776</span> May <span class="m">29</span> 04:12 ibdata1
</span></span><span class="line"><span class="cl">drwxr-x--- <span class="m">2</span> root root     <span class="m">4096</span> May <span class="m">29</span> 04:12 mysql
</span></span><span class="line"><span class="cl">drwxr-x--- <span class="m">2</span> root root     <span class="m">4096</span> May <span class="m">29</span> 04:12 performance_schema
</span></span><span class="line"><span class="cl">drwxr-x--- <span class="m">2</span> root root    <span class="m">12288</span> May <span class="m">29</span> 04:12 sys
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root root       <span class="m">22</span> May <span class="m">29</span> 04:12 xtrabackup_binlog_info
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root root      <span class="m">115</span> May <span class="m">29</span> 04:12 xtrabackup_checkpoints
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root root      <span class="m">461</span> May <span class="m">29</span> 04:12 xtrabackup_info
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root root     <span class="m">2560</span> May <span class="m">29</span> 04:12 xtrabackup_logfile
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中xtrabackup_binlog_info中记录了binlog的坐标。<strong>记住这个坐标。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># cat /backup/2018-05-29_04-12-15/xtrabackup_binlog_info </span>
</span></span><span class="line"><span class="cl">master-bin.000002       <span class="m">154</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后将备份的数据执行&quot;准备&quot;阶段。这个阶段不要求连接mysql，因此不用给连接选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">innobackupex --apply-log /backup/2018-05-29_04-12-15
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后，将/backup目录拷贝到slave上进行恢复。恢复的阶段就是向MySQL的datadir拷贝。但注意，xtrabackup恢复阶段要求datadir必须为空目录。否则报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># innobackupex --copy-back /backup/2018-05-29_04-12-15/</span>
</span></span><span class="line"><span class="cl"><span class="m">180529</span> 23:54:27 innobackupex: Starting the copy-back operation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IMPORTANT: Please check that the copy-back run completes successfully.
</span></span><span class="line"><span class="cl">           At the end of a successful copy-back run innobackupex
</span></span><span class="line"><span class="cl">           prints <span class="s2">&#34;completed OK!&#34;</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">innobackupex version 2.4.11 based on MySQL server 5.7.19 Linux <span class="o">(</span>x86_64<span class="o">)</span> <span class="o">(</span>revision id: b4e0db5<span class="o">)</span>
</span></span><span class="line"><span class="cl">Original data directory /data is not empty!
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以，停止slave的mysql并清空datadir。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">service mysqld stop
</span></span><span class="line"><span class="cl">rm -rf /data/*
</span></span></code></pre></td></tr></table>
</div>
</div><p>恢复时使用的模式是&quot;&ndash;copy-back&quot;，选项后指定要恢复的源备份目录。恢复时因为不需要连接数据库，所以不用指定连接选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># innobackupex --copy-back /backup/2018-05-29_04-12-15/</span>
</span></span><span class="line"><span class="cl"><span class="m">180529</span> 23:55:53 completed OK!
</span></span></code></pre></td></tr></table>
</div>
</div><p>恢复完成后，MySQL的datadir的文件的所有者和属组是innobackupex的调用者，所以需要改回mysql.mysql。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; chown -R mysql.mysql /data
</span></span></code></pre></td></tr></table>
</div>
</div><p>启动slave，并查看恢复是否成功。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; service mysqld start
</span></span><span class="line"><span class="cl">shell&gt; mysql -uroot -p -e <span class="s1">&#39;select * from backuptest.num_isam limit 10;&#39;</span>
</span></span><span class="line"><span class="cl">+----+
</span></span><span class="line"><span class="cl"><span class="p">|</span> n  <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">1</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">2</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">3</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">4</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">5</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">6</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">7</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">8</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">9</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> <span class="m">10</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="slave开启复制">slave开启复制</h3>
<p>经过前面的一番折腾，总算是把该准备的数据都准备到slave上，也获取到master上binlog的坐标(154)。现在还欠东风：连接master。</p>
<p>连接master时，需要使用<code>change master to</code>提供连接到master的连接选项，包括user、port、password、binlog、position等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; change master to 
</span></span><span class="line"><span class="cl">        <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;192.168.100.20&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_port</span><span class="o">=</span>3306,
</span></span><span class="line"><span class="cl">        <span class="nv">master_user</span><span class="o">=</span><span class="s1">&#39;repl&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_password</span><span class="o">=</span><span class="s1">&#39;P@ssword1!&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_log_file</span><span class="o">=</span><span class="s1">&#39;master-bin.000002&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_log_pos</span><span class="o">=</span>154<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完整的<code>change master to</code>语法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">CHANGE MASTER TO option <span class="o">[</span>, option<span class="o">]</span> ...
</span></span><span class="line"><span class="cl">option:
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_HOST</span> <span class="o">=</span> <span class="s1">&#39;host_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_USER</span> <span class="o">=</span> <span class="s1">&#39;user_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;password&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_PORT</span> <span class="o">=</span> port_num
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_LOG_FILE</span> <span class="o">=</span> <span class="s1">&#39;master_log_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_LOG_POS</span> <span class="o">=</span> master_log_pos
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_AUTO_POSITION</span> <span class="o">=</span> <span class="o">{</span>0<span class="p">|</span>1<span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">RELAY_LOG_FILE</span> <span class="o">=</span> <span class="s1">&#39;relay_log_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">RELAY_LOG_POS</span> <span class="o">=</span> relay_log_pos
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL</span> <span class="o">=</span> <span class="o">{</span>0<span class="p">|</span>1<span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_CA</span> <span class="o">=</span> <span class="s1">&#39;ca_file_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_CAPATH</span> <span class="o">=</span> <span class="s1">&#39;ca_directory_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_CERT</span> <span class="o">=</span> <span class="s1">&#39;cert_file_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_CRL</span> <span class="o">=</span> <span class="s1">&#39;crl_file_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_CRLPATH</span> <span class="o">=</span> <span class="s1">&#39;crl_directory_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_KEY</span> <span class="o">=</span> <span class="s1">&#39;key_file_name&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_CIPHER</span> <span class="o">=</span> <span class="s1">&#39;cipher_list&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span> <span class="nv">MASTER_SSL_VERIFY_SERVER_CERT</span> <span class="o">=</span> <span class="o">{</span>0<span class="p">|</span>1<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后，启动IO线程和SQL线程。可以一次性启动两个，也可以分开启动。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 一次性启动、关闭</span>
</span></span><span class="line"><span class="cl">start slave<span class="p">;</span>
</span></span><span class="line"><span class="cl">stop slave<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 单独启动</span>
</span></span><span class="line"><span class="cl">start slave io_thread<span class="p">;</span>
</span></span><span class="line"><span class="cl">start slave sql_thread<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，复制就已经可以开始工作了。当master写入数据，slave就会从master处进行复制。</p>
<p>例如，在master上新建一个表，然后去slave上查看是否有该表。因为是DDL语句，它会写二进制日志，所以它也会复制到slave上。</p>
<h3 id="查看slave的信息">查看slave的信息</h3>
<p><code>change master to</code>后，在slave的datadir下就会生成master.info文件和relay-log.info文件，这两个文件随着复制的进行，其内数据会随之更新。</p>
<h4 id="masterinfo">master.info</h4>
<p>master.info文件记录的是<strong>IO线程相关的信息，</strong> 也就是连接master以及读取master binlog的信息。通过这个文件，下次连接master时就不需要再提供连接选项。</p>
<p>以下是master.info的内容，每一行的意义见<a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/slave-logs-status.html"  target="_blank" rel="noopener"
    >官方手册</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># cat /data/master.info </span>
</span></span><span class="line"><span class="cl"><span class="m">25</span>                        <span class="c1"># 本文件的行数</span>
</span></span><span class="line"><span class="cl">master-bin.000002         <span class="c1"># IO线程正从哪个master binlog读取日志</span>
</span></span><span class="line"><span class="cl"><span class="m">154</span>                       <span class="c1"># IO线程读取到master binlog的位置</span>
</span></span><span class="line"><span class="cl">192.168.100.20            <span class="c1"># master_host</span>
</span></span><span class="line"><span class="cl">repl                      <span class="c1"># master_user</span>
</span></span><span class="line"><span class="cl">P@ssword1!                <span class="c1"># master_password</span>
</span></span><span class="line"><span class="cl"><span class="m">3306</span>                      <span class="c1"># master_port</span>
</span></span><span class="line"><span class="cl"><span class="m">60</span>                        <span class="c1"># master_retry，slave重连master的超时时间(单位秒)</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span><span class="line"><span class="cl">30.000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">86400</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="relay-loginfo">relay-log.info</h4>
<p>relay-log.info文件中记录的是<strong>SQL线程相关的信息。</strong> 以下是relay-log.info文件的内容，每一行的意义见<a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/slave-logs-status.html"  target="_blank" rel="noopener"
    >官方手册</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># cat /data/relay-log.info </span>
</span></span><span class="line"><span class="cl"><span class="m">7</span>                   <span class="c1"># 本文件的行数</span>
</span></span><span class="line"><span class="cl">./slave-bin.000001  <span class="c1"># 当前SQL线程正在读取的relay-log文件</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span>                   <span class="c1"># SQL线程已执行到的relay log位置</span>
</span></span><span class="line"><span class="cl">master-bin.000002   <span class="c1"># SQL线程最近执行的操作对应的是哪个master binlog</span>
</span></span><span class="line"><span class="cl"><span class="m">154</span>                 <span class="c1"># SQL线程最近执行的操作对应的是master binlog的哪个位置</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>                   <span class="c1"># slave上必须落后于master多长时间</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>                   <span class="c1"># 正在运行的SQL线程数</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>                   <span class="c1"># 一种用于内部信息交流的ID，目前值总是1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="show-slave-status">show slave status</h4>
<p>在slave上执行show slave status可以查看slave的状态信息。信息非常多，每个字段的详细意义可参见<a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/show-slave-status.html"  target="_blank" rel="noopener"
    >官方手册</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show slave status<span class="se">\G</span>
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">               Slave_IO_State:        <span class="c1"># slave上IO线程的状态，来源于show processlist</span>
</span></span><span class="line"><span class="cl">                  Master_Host: 192.168.100.20
</span></span><span class="line"><span class="cl">                  Master_User: repl
</span></span><span class="line"><span class="cl">                  Master_Port: <span class="m">3306</span>
</span></span><span class="line"><span class="cl">                Connect_Retry: <span class="m">60</span>
</span></span><span class="line"><span class="cl">              Master_Log_File: master-bin.000002
</span></span><span class="line"><span class="cl">          Read_Master_Log_Pos: <span class="m">154</span>
</span></span><span class="line"><span class="cl">               Relay_Log_File: slave-bin.000001
</span></span><span class="line"><span class="cl">                Relay_Log_Pos: <span class="m">4</span>
</span></span><span class="line"><span class="cl">        Relay_Master_Log_File: master-bin.000002
</span></span><span class="line"><span class="cl">             Slave_IO_Running: No          <span class="c1"># IO线程的状态，此处为未运行且未连接状态</span>
</span></span><span class="line"><span class="cl">            Slave_SQL_Running: No          <span class="c1"># SQL线程的状态，此处为未运行状态</span>
</span></span><span class="line"><span class="cl">              Replicate_Do_DB:             <span class="c1"># 显式指定要复制的数据库</span>
</span></span><span class="line"><span class="cl">          Replicate_Ignore_DB:             <span class="c1"># 显式指定要忽略的数据库</span>
</span></span><span class="line"><span class="cl">           Replicate_Do_Table: 
</span></span><span class="line"><span class="cl">       Replicate_Ignore_Table: 
</span></span><span class="line"><span class="cl">      Replicate_Wild_Do_Table:          <span class="c1"># 以通配符方式指定要复制的表</span>
</span></span><span class="line"><span class="cl">  Replicate_Wild_Ignore_Table: 
</span></span><span class="line"><span class="cl">                   Last_Errno: <span class="m">0</span>
</span></span><span class="line"><span class="cl">                   Last_Error: 
</span></span><span class="line"><span class="cl">                 Skip_Counter: <span class="m">0</span>
</span></span><span class="line"><span class="cl">          Exec_Master_Log_Pos: <span class="m">154</span>
</span></span><span class="line"><span class="cl">              Relay_Log_Space: <span class="m">154</span>
</span></span><span class="line"><span class="cl">              Until_Condition: None     <span class="c1"># start slave语句中指定的until条件，</span>
</span></span><span class="line"><span class="cl">                                        <span class="c1"># 例如，读取到哪个binlog位置就停止</span>
</span></span><span class="line"><span class="cl">               Until_Log_File: 
</span></span><span class="line"><span class="cl">                Until_Log_Pos: <span class="m">0</span>
</span></span><span class="line"><span class="cl">           Master_SSL_Allowed: No
</span></span><span class="line"><span class="cl">           Master_SSL_CA_File: 
</span></span><span class="line"><span class="cl">           Master_SSL_CA_Path: 
</span></span><span class="line"><span class="cl">              Master_SSL_Cert: 
</span></span><span class="line"><span class="cl">            Master_SSL_Cipher: 
</span></span><span class="line"><span class="cl">               Master_SSL_Key: 
</span></span><span class="line"><span class="cl">        Seconds_Behind_Master: NULL    <span class="c1"># SQL线程执行过的位置比IO线程慢多少</span>
</span></span><span class="line"><span class="cl">Master_SSL_Verify_Server_Cert: No
</span></span><span class="line"><span class="cl">                Last_IO_Errno: <span class="m">0</span>
</span></span><span class="line"><span class="cl">                Last_IO_Error: 
</span></span><span class="line"><span class="cl">               Last_SQL_Errno: <span class="m">0</span>
</span></span><span class="line"><span class="cl">               Last_SQL_Error: 
</span></span><span class="line"><span class="cl">  Replicate_Ignore_Server_Ids: 
</span></span><span class="line"><span class="cl">             Master_Server_Id: <span class="m">0</span>      <span class="c1"># master的server id</span>
</span></span><span class="line"><span class="cl">                  Master_UUID: 
</span></span><span class="line"><span class="cl">             Master_Info_File: /data/master.info
</span></span><span class="line"><span class="cl">                    SQL_Delay: <span class="m">0</span>
</span></span><span class="line"><span class="cl">          SQL_Remaining_Delay: NULL
</span></span><span class="line"><span class="cl">      Slave_SQL_Running_State:             <span class="c1"># slave SQL线程的状态</span>
</span></span><span class="line"><span class="cl">           Master_Retry_Count: <span class="m">86400</span>
</span></span><span class="line"><span class="cl">                  Master_Bind: 
</span></span><span class="line"><span class="cl">      Last_IO_Error_Timestamp: 
</span></span><span class="line"><span class="cl">     Last_SQL_Error_Timestamp: 
</span></span><span class="line"><span class="cl">               Master_SSL_Crl: 
</span></span><span class="line"><span class="cl">           Master_SSL_Crlpath: 
</span></span><span class="line"><span class="cl">           Retrieved_Gtid_Set: 
</span></span><span class="line"><span class="cl">            Executed_Gtid_Set: 
</span></span><span class="line"><span class="cl">                Auto_Position: <span class="m">0</span>
</span></span><span class="line"><span class="cl">         Replicate_Rewrite_DB: 
</span></span><span class="line"><span class="cl">                 Channel_Name: 
</span></span><span class="line"><span class="cl">           Master_TLS_Version: 
</span></span><span class="line"><span class="cl"><span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为太长，后面再列出<code>show slave status</code>时，将裁剪一些意义不大的行。</p>
<p>再次回到上面<code>show slave status</code>的信息。除了那些描述IO线程、SQL线程状态的行，还有几个log_file和pos相关的行，如下所列。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Master_Log_File: master-bin.000002
</span></span><span class="line"><span class="cl">  Read_Master_Log_Pos: <span class="m">154</span>
</span></span><span class="line"><span class="cl">       Relay_Log_File: slave-bin.000001
</span></span><span class="line"><span class="cl">        Relay_Log_Pos: <span class="m">4</span>
</span></span><span class="line"><span class="cl">Relay_Master_Log_File: master-bin.000002
</span></span><span class="line"><span class="cl">  Exec_Master_Log_Pos: <span class="m">154</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>理解这几行的意义至关重要，前面因为排版限制，描述看上去有些重复。所以这里完整地描述它们：</p>
<ul>
<li><code>Master_Log_File</code>：IO线程正在读取的master binlog；</li>
<li><code>Read_Master_Log_Pos</code>：IO线程已经读取到master binlog的哪个位置；</li>
<li><code>Relay_Log_File</code>：SQL线程正在读取和执行的relay log；</li>
<li><code>Relay_Log_Pos</code>：SQL线程已经读取和执行到relay log的哪个位置；</li>
<li><code>Relay_Master_Log_File</code>：SQL线程最近执行的操作对应的是哪个master binlog；</li>
<li><code>Exec_Master_Log_Pos</code>：SQL线程最近执行的操作对应的是master binlog的哪个位置。</li>
</ul>
<p>所以，(Relay_Master_Log_File, Exec_Master_log_Pos)构成一个坐标，这个坐标表示slave上已经将master上的哪些数据重放到自己的实例中，它可以用于下一次<code>change master to</code>时指定的binlog坐标。</p>
<p>与这个坐标相对应的是slave上SQL线程的relay log坐标(Relay_Log_File, Relay_Log_Pos)。这两个坐标位置不同，但它们对应的数据是一致的。</p>
<p>最后还有一个延迟参数<code>Seconds_Behind_Master</code>需要说明一下，它的本质意义是SQL线程比IO线程慢多少。如果master和slave之间的网络状况优良，那么slave的IO线程读速度和master写binlog的速度基本一致，所以这个参数也用来描述&quot;SQL线程比master慢多少&quot;，也就是说slave比master少多少数据，只不过衡量的单位是秒。但需要注意，这个参数的描述并不标准，只有在网速很好的时候做个大概估计，很多种情况下它的值都是0，即使SQL线程比IO线程慢了很多也是如此。</p>
<h4 id="slave信息汇总">slave信息汇总</h4>
<p>上面的master.info、relay-log.info和<code>show slave status</code>的状态都是刚连接上master还未启动IO thread、SQL thread时的状态。下面将显示已经进行一段正在执行复制的slave状态。</p>
<p>首先查看启动io thread和sql thread后的状态。使用<code>show processlist</code>查看即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; start slave<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; show processlist<span class="p">;</span>   <span class="c1"># slave上的信息，为了排版，简化了输出</span>
</span></span><span class="line"><span class="cl">+----+-------------+---------+--------------------------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Id <span class="p">|</span> User        <span class="p">|</span> Command <span class="p">|</span> State                                                  <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+-------------+---------+--------------------------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">4</span> <span class="p">|</span> root        <span class="p">|</span> Sleep   <span class="p">|</span>                                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">7</span> <span class="p">|</span> root        <span class="p">|</span> Query   <span class="p">|</span> starting                                               <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">8</span> <span class="p">|</span> system user <span class="p">|</span> Connect <span class="p">|</span> Waiting <span class="k">for</span> master to send event                       <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">9</span> <span class="p">|</span> system user <span class="p">|</span> Connect <span class="p">|</span> Slave has <span class="nb">read</span> all relay log<span class="p">;</span> waiting <span class="k">for</span> more updates <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+-------------+---------+--------------------------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到：</p>
<ul>
<li>Id=8的线程负责连接master并读取binlog，它是IO 线程，它的状态指示&quot;等待master发送更多的事件&quot;；</li>
<li>Id=9的线程负责读取relay log，它是SQL线程，它的状态指示&quot;已经读取了所有的relay log&quot;。</li>
</ul>
<p>再看看此时master上的信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show processlist<span class="p">;</span>        <span class="c1"># master上的信息，为了排版，经过了修改</span>
</span></span><span class="line"><span class="cl">+----+------+-----------------------+-------------+--------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Id <span class="p">|</span> User <span class="p">|</span> Host                  <span class="p">|</span> Command     <span class="p">|</span> State                                <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+------+-----------------------+-------------+--------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span>  <span class="m">4</span> <span class="p">|</span> root <span class="p">|</span> localhost             <span class="p">|</span> Query       <span class="p">|</span> starting                             <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>----<span class="p">|</span>------<span class="p">|</span>-----------------------<span class="p">|</span>-------------<span class="p">|</span>--------------------------------------<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> <span class="m">16</span> <span class="p">|</span> repl <span class="p">|</span> 192.168.100.150:39556 <span class="p">|</span> Binlog Dump <span class="p">|</span> Master has sent all binlog to slave<span class="p">;</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>    <span class="p">|</span>      <span class="p">|</span>                       <span class="p">|</span>             <span class="p">|</span> waiting <span class="k">for</span> more updates             <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----+------+-----------------------+-------------+--------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>master上有一个<code>Id=16</code>的binlog dump线程，该线程的用户是repl。它的状态指示&quot;已经将所有的binlog发送给slave了&quot;。</p>
<p>现在，在master上执行一个长事件，以便查看slave上的状态信息。</p>
<p>仍然使用前面插入数值辅助表的存储过程，这次分别向两张表中插入一亿条数据(尽管去抽烟、喝茶，够等几分钟的。如果机器性能不好，请大幅减少插入的行数)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">call</span><span class="w"> </span><span class="nf">proc_num1</span><span class="p">(</span><span class="mi">100000000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">call</span><span class="w"> </span><span class="nf">proc_num2</span><span class="p">(</span><span class="mi">100000000</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后去slave上查看信息，如下。因为太长，已经裁剪了一部分没什么用的行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show slave status<span class="se">\G</span>
</span></span><span class="line"><span class="cl">mysql: <span class="o">[</span>Warning<span class="o">]</span> Using a password on the <span class="nb">command</span> line interface can be insecure.
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">               Slave_IO_State: Waiting <span class="k">for</span> master to send event
</span></span><span class="line"><span class="cl">                  Master_Host: 192.168.100.20
</span></span><span class="line"><span class="cl">                  Master_User: repl
</span></span><span class="line"><span class="cl">                  Master_Port: <span class="m">3306</span>
</span></span><span class="line"><span class="cl">                Connect_Retry: <span class="m">60</span>
</span></span><span class="line"><span class="cl">              Master_Log_File: master-bin.000003
</span></span><span class="line"><span class="cl">          Read_Master_Log_Pos: <span class="m">512685413</span>
</span></span><span class="line"><span class="cl">               Relay_Log_File: slave-bin.000003
</span></span><span class="line"><span class="cl">                Relay_Log_Pos: <span class="m">336989434</span>
</span></span><span class="line"><span class="cl">        Relay_Master_Log_File: master-bin.000003
</span></span><span class="line"><span class="cl">             Slave_IO_Running: Yes
</span></span><span class="line"><span class="cl">            Slave_SQL_Running: Yes
</span></span><span class="line"><span class="cl">          Exec_Master_Log_Pos: <span class="m">336989219</span>
</span></span><span class="line"><span class="cl">      Slave_SQL_Running_State: Reading event from the relay log
</span></span></code></pre></td></tr></table>
</div>
</div><p>从中获取到的信息有：</p>
<ul>
<li>IO线程的状态</li>
<li>SQL线程的状态</li>
<li>IO线程读取到master binlog的哪个位置：512685413</li>
<li>SQL线程已经执行到relay log的哪个位置：336989434</li>
<li>SQL线程执行的位置对应于master binlog的哪个位置：336989219</li>
</ul>
<p>可以看出，IO线程比SQL线程超前了很多很多，所以SQL线程比IO线程的延迟较大。</p>
<h3 id="mysql复制如何实现断开重连">MySQL复制如何实现断开重连</h3>
<p>很多人以为<code>change master to</code>语句是用来连接master的，实际上这种说法是错的。连接master是IO线程的事情，<code>change master to</code>只是为IO线程连接master时提供连接参数。</p>
<p>如果slave从来没连接过master，那么必须使用<code>change master to</code>语句来生成IO线程所需要的信息，这些信息记录在master.info中。这个文件是<code>change master to</code>成功之后立即生成的，以后启动IO线程时，IO线程都会自动读取这个文件来连接master，不需要先执行<code>change master to</code>语句。</p>
<p>例如，可以随时<code>stop slave</code>来停止复制线程，然后再随时<code>start slave</code>，只要master.info存在，且没有人为修改过它，IO线程就一定不会出错。这是因为master.info会随着IO线程的执行而更新，无论读取到master binlog的哪个位置，都会记录下这个位置，如此一来，IO线程下次启动的时候就知道从哪里开始监控master binlog。</p>
<p>前面还提到一个文件：<code>relay-log.info</code>文件。这个文件中记录的是SQL线程的相关信息，包括读取、执行到relay log的哪个位置，刚重放的数据对应master binlog的哪个位置。随着复制的进行，这个文件的信息会即时改变。所以，通过relay-log.info，下次SQL线程启动的时候就能知道从relay log的哪个地方继续读取、执行。</p>
<p>如果不小心把relay log文件删除了，SQL线程可能会丢失了一部分相比IO线程延迟的数据。这时候，只需将relay-log.info中第4、5行记录的&quot;SQL线程刚重放的数据对应master binlog的坐标&quot;手动修改到master.info中即可，这样IO线程下次连接master就会从master binlog的这个地方开始监控。当然，也可以将这个坐标作为<code>change master to</code>的坐标来修改master.info。</p>
<p>此外，当mysql实例启动时，默认会自动<code>start slave</code>，也就是MySQL一启动就自动开启复制线程。如果想要禁止这种行为，在配置文件中加上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[mysqld]</span>
</span></span><span class="line"><span class="cl"><span class="na">skip-slave-start</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="一些变量">一些变量</h3>
<p>默认情况下，slave连接到master后会在slave的datadir下生成master.info和relay-log.info文件，但是这是可以通过设置变量来改变的。</p>
<ul>
<li><code>master-info-repository={TABLE|FILE}</code>：master的信息是记录到文件master.info中还是记录到表mysql.slave_master_info中。默认为file。</li>
<li><code>relay-log-info-repository={TABLE|FILE}</code>：slave的信息是记录到文件relay-log.info中还是记录到表mysql.slave_relay_log_info中。默认为file。
IO线程每次从master复制日志要写入到relay log中，但是它是先放在内存的，等到一定时机后才会将其刷到磁盘上的relay log文件中。刷到磁盘的时机可以由变量控制。</li>
</ul>
<p>另外，IO线程每次从master复制日志后都会更新master.info的信息，也是先更新内存中信息，在特定的时候才会刷到磁盘的master.info文件；同理SQL线程更新realy-log.info也是一样的。它们是可以通过变量来设置更新时机的。</p>
<ul>
<li><code>sync-relay-log=N</code>：设置为大于0的数表示每从master复制N个事件就刷一次盘。设置为0表示依赖于操作系统的sync机制。</li>
<li><code>sync-master-info=N</code>：依赖于<code>master-info-repository</code>的设置，如果为file，则设置为大于0的值时表示每更新多少次master.info将其写入到磁盘的master.info中，设置为0则表示由操作系统来决定何时调用fdatasync()函数刷到磁盘。如果设置为table，则设置为大于0的值表示每更新多少次master.info就更新mysql.slave_master_info表一次，如果设置为0则表示永不更新该表。</li>
<li><code>sync-relay-log-info=N</code>：同上。</li>
</ul>
<h2 id="一主多从">一主多从</h2>
<p>一主多从有两种情况，结构图如下。</p>
<p>以下是一主多从的结构图(和一主一从的配置方法完全一致)：</p>
<p><img src="/post/mysql-replication-1/img_9.png"
	width="564"
	height="361"
	srcset="/post/mysql-replication-1/img_9_huc4ee65850f1ed9ea7822a57680da05f7_27570_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_9_huc4ee65850f1ed9ea7822a57680da05f7_27570_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="156"
		data-flex-basis="374px"
	
></p>
<p>以下是一主多从，但某slave是另一群MySQL实例的master：</p>
<p><img src="/post/mysql-replication-1/img_10.png"
	width="543"
	height="499"
	srcset="/post/mysql-replication-1/img_10_hu92390d13ad17bfd600cafb6ca41583c9_37805_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_10_hu92390d13ad17bfd600cafb6ca41583c9_37805_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="261px"
	
></p>
<p>配置一主多从时，需要考虑一件事：slave上是否要开启binlog? 如果不开启slave的binlog，性能肯定要稍微好一点。但是开启了binlog后，可以通过slave来备份数据，也可以在master宕机时直接将slave切换为新的master。此外，如果是上面第二种主从结构，这台slave必须开启binlog。可以将某台或某几台slave开启binlog，并在mysql动静分离的路由算法上稍微减少一点到这些slave上的访问权重。</p>
<p>上面第一种一主多从的结构没什么可解释的，它和一主一从的配置方式完全一样，但是可以考虑另一种情况：向现有主从结构中添加新的slave。所以，稍后先介绍这种添加slave，再介绍第二种一主多从的结构。</p>
<h3 id="向现有主从结构中添加slave">向现有主从结构中添加slave</h3>
<p>官方手册：<a class="link" href="https://dev.mysql.com/doc/refman/5.7/en/replication-howto-additionalslaves.html"  target="_blank" rel="noopener"
    >https://dev.mysql.com/doc/refman/5.7/en/replication-howto-additionalslaves.html</a></p>
<p>例如在前文一主一从的实验环境下添加一台新的slave。</p>
<p>因为新的slave在开始复制前，要有master上的基准数据，还要有master binlog的坐标。按照前文一主一从的配置方式，当然很容易获取这些信息，但这样会将master锁住一段时间(因为要备份基准数据)。</p>
<p>深入思考一下，其实slave上也有数据，还有relay log以及一些仓库文件标记着数据复制到哪个地方。所以，<strong>完全可以从slave上获取基准数据和坐标，也建议这样做。</strong></p>
<p>仍然有三种方法从slave上获取基准数据：冷备份、mysqldump和xtrabackup。方法见前文将slave恢复到master指定的坐标。</p>
<p>其实<strong>临时关闭一个slave对业务影响很小，所以我个人建议，新添加slave时采用冷备份slave的方式</strong>，不仅备份恢复的速度最快，配置成slave也最方便，这一点和前面配置&quot;一主一从&quot;不一样。但冷备份slave的时候需要注意几点：</p>
<ol>
<li>可以考虑将slave1完全shutdown再将整个datadir拷贝到新的slave2上。</li>
<li>建议新的slave2配置文件中的&quot;relay-log&quot;的值和slave1的值完全一致，否则应该手动从slave2的relay-log.info中获取IO线程连接master时的坐标，并在slave2上使用<code>change master to</code>语句设置连接参数。</li>
</ol>
<p>方法很简单，所以不做演示了。</p>
<h3 id="配置一主多从从中有从">配置一主多从(从中有从)</h3>
<p>此处实现的一主多从是下面这种结构：</p>
<p><img src="/post/mysql-replication-1/img_11.png"
	width="543"
	height="497"
	srcset="/post/mysql-replication-1/img_11_hu4d935159534b6bc9afe32fc700e36773_38026_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_11_hu4d935159534b6bc9afe32fc700e36773_38026_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="109"
		data-flex-basis="262px"
	
></p>
<p>这种结构对MySQL复制来说，是一个很好的提升性能的方式。对于只有一个master的主从复制结构，每多一个slave，意味着master多发一部分binlog，业务稍微繁忙一点时，这种压力会加剧。而这种一个主master、一个或多个辅助master的主从结构，非常有助于MySQL集群的伸缩性，对压力的适应性也很强。</p>
<p>除上面一主多从、从中有从的方式可提升复制性能，还有几种提升MySQL复制性能的方式：</p>
<ul>
<li>将不同数据库复制到不同slave上。</li>
<li>可以将master上的事务表(如InnoDB)复制为slave上的非事务表(如MyISAM)，这样slave上回放的速度加快，查询数据的速度在一定程度上也会提升。</li>
</ul>
<p>回到这种主从结构，它有些不同，master只负责传送日志给slave1、slave2和slave3，slave 2_1和slave 2_2的日志由slave2负责传送，所以slave2上也必须要开启binlog选项。此外，还必须开启一个选项<code>--log-slave-updates让slave2</code>能够在重放relay log时也写自己的binlog，否则slave2的binlog仅接受人为的写操作。</p>
<p><strong>问：slave能否进行写操作？重放relay log的操作是否会记录到slave的binlog中？</strong></p>
<p>1、在slave上没有开启<code>read-only</code>选项(只读变量)时，任何有写权限的用户都可以进行写操作，这些操作都会记录到binlog中。注意，<strong>read-only选项对具有super权限的用户以及SQL线程执行的重放写操作无效。</strong> 默认这个选项是关闭的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show variables like <span class="s2">&#34;read_only&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">+---------------+-------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Variable_name <span class="p">|</span> Value <span class="p">|</span>
</span></span><span class="line"><span class="cl">+---------------+-------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> read_only     <span class="p">|</span> OFF   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+---------------+-------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>2、在slave上没有开启log-slave-updates和binlog选项时，重放relay log不会记录binlog。</p>
<p><strong>所以如果slave2要作为某些slave的master，那么在slave2上必须要开启<code>log-slave-updates</code>和binlog选项。为了安全和数据一致性，在slave2上还应该启用read-only选项。</strong></p>
<p>环境如下：</p>
<p><img src="/post/mysql-replication-1/img_12.png"
	width="928"
	height="385"
	srcset="/post/mysql-replication-1/img_12_hua1b26a0f2028e8c2a7e249a0b206a403_28840_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_12_hua1b26a0f2028e8c2a7e249a0b206a403_28840_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="241"
		data-flex-basis="578px"
	
></p>
<p>以下是master、slave1和slave2上配置文件内容。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="c1"># master上的配置</span>
</span></span><span class="line"><span class="cl"><span class="k">[mysqld]</span>
</span></span><span class="line"><span class="cl"><span class="na">datadir</span><span class="o">=</span><span class="s">/data</span>
</span></span><span class="line"><span class="cl"><span class="na">socket</span><span class="o">=</span><span class="s">/data/mysql.sock</span>
</span></span><span class="line"><span class="cl"><span class="na">server_id</span><span class="o">=</span><span class="s">100</span>
</span></span><span class="line"><span class="cl"><span class="na">sync-binlog</span><span class="o">=</span><span class="s">1</span>
</span></span><span class="line"><span class="cl"><span class="na">log_bin</span><span class="o">=</span><span class="s">master-bin</span>
</span></span><span class="line"><span class="cl"><span class="na">log-error</span><span class="o">=</span><span class="s">/data/err.log</span>
</span></span><span class="line"><span class="cl"><span class="na">pid-file</span><span class="o">=</span><span class="s">/data/mysqld.pid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># slave1上的配置</span>
</span></span><span class="line"><span class="cl"><span class="k">[mysqld]</span>
</span></span><span class="line"><span class="cl"><span class="na">datadir</span><span class="o">=</span><span class="s">/data</span>
</span></span><span class="line"><span class="cl"><span class="na">socket</span><span class="o">=</span><span class="s">/data/mysql.sock</span>
</span></span><span class="line"><span class="cl"><span class="na">server_id</span><span class="o">=</span><span class="s">111</span>
</span></span><span class="line"><span class="cl"><span class="na">relay-log</span><span class="o">=</span><span class="s">slave-bin</span>
</span></span><span class="line"><span class="cl"><span class="na">log-error</span><span class="o">=</span><span class="s">/data/err.log</span>
</span></span><span class="line"><span class="cl"><span class="na">pid-file</span><span class="o">=</span><span class="s">/data/mysqld.pid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">log-slave-updates          # 新增配置</span>
</span></span><span class="line"><span class="cl"><span class="na">log-bin</span><span class="o">=</span><span class="s">master-slave-bin   # 新增配置</span>
</span></span><span class="line"><span class="cl"><span class="na">read-only</span><span class="o">=</span><span class="s">ON               # 新增配置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># slave2上的配置</span>
</span></span><span class="line"><span class="cl"><span class="k">[mysqld]</span>
</span></span><span class="line"><span class="cl"><span class="na">datadir</span><span class="o">=</span><span class="s">/data</span>
</span></span><span class="line"><span class="cl"><span class="na">socket</span><span class="o">=</span><span class="s">/data/mysql.sock</span>
</span></span><span class="line"><span class="cl"><span class="na">server_id</span><span class="o">=</span><span class="s">123</span>
</span></span><span class="line"><span class="cl"><span class="na">relay-log</span><span class="o">=</span><span class="s">slave-bin</span>
</span></span><span class="line"><span class="cl"><span class="na">log-error</span><span class="o">=</span><span class="s">/data/err.log</span>
</span></span><span class="line"><span class="cl"><span class="na">pid-file</span><span class="o">=</span><span class="s">/data/mysqld.pid</span>
</span></span><span class="line"><span class="cl"><span class="na">read-only</span><span class="o">=</span><span class="s">ON</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为slave2目前是全新的实例，所以先将slave1的基准数据备份到slave2。由于slave1自身就是slave，临时关闭一个slave对业务影响很小，所以直接采用冷备份slave的方式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 在slave2上执行</span>
</span></span><span class="line"><span class="cl">shell&gt; mysqladmin -uroot -p shutdown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在slave1上执行：</span>
</span></span><span class="line"><span class="cl">shell&gt; mysqladmin -uroot -p shutdown
</span></span><span class="line"><span class="cl">shell&gt; rsync -az --delete /data 192.168.100.19:/
</span></span><span class="line"><span class="cl">shell&gt; service mysqld start
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>冷备份时，以下几点千万注意：</strong></p>
<ol>
<li>因为slave2是slave1的从，所以在启动MySQL前必须将备份到slave2上的和复制有关的文件都删除。包括：
<ol>
<li>master.info。除非配置文件中指定了<code>skip-slave-start</code>，否则slave2将再次连接到master并作为master的slave。</li>
<li>relay-log.info。因为slave1启动后会继续执行relay log中的内容(如果有未执行的)，这时slave1会将这部分写入binlog并传送到slave2。</li>
<li>删除relay log文件。其实不是必须删除，但建议删除。</li>
<li>删除relay log index文件。</li>
<li>删除DATADIR/auto.conf。这个文件必须删除，因为这里面保留了mysql server的UUID，而master和slave的UUID必须不能一致。在启动mysql的时候，如果没有这个文件会自动生成自己的UUID并保存到auto.conf中。</li>
</ol>
</li>
<li>检查slave1上从master复制过来的专门用于复制的用户<code>repl</code>是否允许slave2连接。如果不允许，应该去master上修改这个用户。</li>
<li>因为slave1是刚开启的binlog，所以slave2连接slave1时的binlog position应该指定为4。即使slave1不是刚开启的binlog，它在重启后也会滚动binlog。</li>
</ol>
<p>所以，在slave2上继续操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; ls /data
</span></span><span class="line"><span class="cl">auto.cnf    ib_buffer_pool  ib_logfile1  performance_schema  slave-bin.000005
</span></span><span class="line"><span class="cl">backuptest  ibdata1         master.info  relay-log.info      slave-bin.index
</span></span><span class="line"><span class="cl">err.log     ib_logfile0     mysql        slave-bin.000004    sys            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">shell&gt; rm -f /data/<span class="o">{</span>master.info,relay-log.info,auto.conf,slave-bin*<span class="o">}</span>
</span></span><span class="line"><span class="cl">shell&gt; service mysqld start
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后连上slave2，启动复制线程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; mysql -uroot -p
</span></span><span class="line"><span class="cl">mysql&gt; change master to
</span></span><span class="line"><span class="cl">        <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;192.168.100.150&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_port</span><span class="o">=</span>3306,
</span></span><span class="line"><span class="cl">        <span class="nv">master_user</span><span class="o">=</span><span class="s1">&#39;repl&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_password</span><span class="o">=</span><span class="s1">&#39;P@ssword1!&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_log_file</span><span class="o">=</span><span class="s1">&#39;master-slave-bin.000001&#39;</span>,
</span></span><span class="line"><span class="cl">        <span class="nv">master_log_pos</span><span class="o">=</span>4<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; start slave<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; show slave status<span class="se">\G</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mysql复制中一些常用操作">MySQL复制中一些常用操作</h2>
<h3 id="筛选要复制的库和表">筛选要复制的库和表</h3>
<p>默认情况下，slave会复制master上所有库。可以指定以下变量显式指定要复制的库、表和要忽略的库、表，也可以将其写入配置文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl">            <span class="na">Replicate_Do_DB: 要复制的数据库</span>
</span></span><span class="line"><span class="cl">        <span class="na">Replicate_Ignore_DB: 不复制的数据库</span>
</span></span><span class="line"><span class="cl">         <span class="na">Replicate_Do_Table: 要复制的表</span>
</span></span><span class="line"><span class="cl">     <span class="na">Replicate_Ignore_Table: 不复制的表</span>
</span></span><span class="line"><span class="cl">    <span class="na">Replicate_Wild_Do_Table: 通配符方式指定要复制的表</span>
</span></span><span class="line"><span class="cl"><span class="na">Replicate_Wild_Ignore_Table: 通配符方式指定不复制的表</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果要指定列表，则多次使用这些变量进行设置。</p>
<p>需要注意的是，<strong>尽管显式指定了要复制和忽略的库或者表，但是master还是会将所有的binlog传给slave并写入到slave的relay log中，真正负责筛选的slave上的SQL线程。</strong></p>
<p>另外，如果slave上开启了binlog，SQL线程读取relay log后会将所有的事件都写入到自己的binlog中，只不过对于那些被忽略的事件只记录相关的事务号等信息，不记录事务的具体内容。所以，如果之前设置了被忽略的库或表，后来取消忽略后，它们在取消忽略以前的变化是不会再重放的，特别是基于gtid的复制会严格比较binlog中的gtid。</p>
<p>总之使用筛选的时候应该多多考虑是否真的要筛选，是否是永久筛选。</p>
<h3 id="reset-slave和reset-master">reset slave和reset master</h3>
<p><code>reset slave</code>会删除master.info/relay-log.info和relay log，然后新生成一个relay log。但是<code>change master to</code>设置的连接参数还在内存中保留着，所以此时可以直接start slave，并根据内存中的<code>change master to</code>连接参数复制日志。</p>
<p><code>reset slave all</code>除了删除<code>reset slave</code>删除的东西，还删除内存中的<code>change master to</code>设置的连接信息。</p>
<p><code>reset master</code>会删除master上所有的二进制日志，并新建一个日志。在正常运行的主从复制环境中，执行<code>reset master</code>很可能导致异常状况。所以建议使用purge来删除某个时间点之前的日志(应该保证只删除那些已经复制完成的日志)。</p>
<h3 id="show-slave-hosts">show slave hosts</h3>
<p>如果想查看master有几个slave的信息，可以使用show slave hosts。以下为某个master上的结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show slave hosts<span class="p">;</span> 
</span></span><span class="line"><span class="cl">+-----------+------+------+-----------+--------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Server_id <span class="p">|</span> Host <span class="p">|</span> Port <span class="p">|</span> Master_id <span class="p">|</span> Slave_UUID                           <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-----------+------+------+-----------+--------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="m">111</span> <span class="p">|</span>      <span class="p">|</span> <span class="m">3306</span> <span class="p">|</span>        <span class="m">11</span> <span class="p">|</span> ff7bb057-2466-11e7-8591-000c29479b32 <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>      <span class="m">1111</span> <span class="p">|</span>      <span class="p">|</span> <span class="m">3306</span> <span class="p">|</span>        <span class="m">11</span> <span class="p">|</span> 9b119463-24d2-11e7-884e-000c29867ec2 <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-----------+------+------+-----------+--------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，该show中会显示server-id、slave的主机地址和端口号、它们的master_id以及这些slave独一无二的uuid号。</p>
<p>其中show结果中的host显示结果是由slave上的变量report_host控制的，端口是由report_port控制的。</p>
<p>例如，在slave2上修改其配置文件，添加report-host项后重启MySQL服务。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[mysqld]</span>
</span></span><span class="line"><span class="cl"><span class="na">report_host</span><span class="o">=</span><span class="s">192.168.100.19</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在slave1(前文的实验环境，slave1是slave2的master)上查看，host已经显示为新配置的项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show slave hosts<span class="p">;</span>
</span></span><span class="line"><span class="cl">+-----------+----------------+------+-----------+--------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Server_id <span class="p">|</span> Host           <span class="p">|</span> Port <span class="p">|</span> Master_id <span class="p">|</span> Slave_UUID                           <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-----------+----------------+------+-----------+--------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span>       <span class="m">111</span> <span class="p">|</span> 192.168.100.19 <span class="p">|</span> <span class="m">3306</span> <span class="p">|</span>        <span class="m">11</span> <span class="p">|</span> ff7bb057-2466-11e7-8591-000c29479b32 <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>      <span class="m">1111</span> <span class="p">|</span>                <span class="p">|</span> <span class="m">3306</span> <span class="p">|</span>        <span class="m">11</span> <span class="p">|</span> 9b119463-24d2-11e7-884e-000c29867ec2 <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-----------+----------------+------+-----------+--------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="多线程复制">多线程复制</h3>
<p>在老版本中，只有一个SQL线程读取relay log并重放。重放的速度肯定比IO线程写relay log的速度慢非常多，导致SQL线程非常繁忙，且<strong>实现到从库上延迟较大。没错，多线程复制可以解决主从延迟问题，且使用得当的话效果非常的好(关于主从复制延迟，是生产环境下最常见的问题之一，且没有很好的办法来避免。后文稍微介绍了一点方法)。</strong></p>
<p>在MySQL 5.6中引入了多线程复制(multi-thread slave，简称MTS)，这个<strong>多线程指的是多个SQL线程，IO线程还是只有一个。</strong> 当IO线程将master binlog写入relay log中后，一个称为&quot;多线程协调器(multithreaded slave coordinator)&ldquo;会对多个SQL线程进行调度，让它们按照一定的规则去执行relay log中的事件。</p>
<p><strong>需要谨记于心的是，如果对多线程复制没有了解的很透彻，千万不要在生产环境中使用多线程复制。</strong> 它的确带来了一些复制性能的提升，并且能解决主从超高延迟的问题，但随之而来的是很多的&quot;疑难杂症&rdquo;，这些&quot;疑难杂症&quot;并非是bug，只是需要多多了解之后才知道为何会出现这些问题以及如何解决这些问题。稍后会简单介绍一种多线程复制问题：gaps。</p>
<p>通过全局变量<code>slave-parallel-workers</code>控制SQL线程个数，设置为非0正整数N，表示多加N个SQL线程，加上原有的共N+1个SQL线程。默认为0，表示不加任何SQL线程，即关闭多线程功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; show variables like <span class="s2">&#34;%parallel%&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">+------------------------+-------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Variable_name          <span class="p">|</span> Value <span class="p">|</span>
</span></span><span class="line"><span class="cl">+------------------------+-------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> slave_parallel_workers <span class="p">|</span> <span class="m">0</span>     <span class="p">|</span>
</span></span><span class="line"><span class="cl">+------------------------+-------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>显然，多线程只有在slave上开启才有效，因为只有slave上才有SQL线程。另外，设置了该全局变量，需要重启SQL线程才生效，否则内存中还是只有一个SQL线程。</p>
<p>例如，初始时slave上的processlist如下：</p>
<p><img src="/post/mysql-replication-1/img_13.png"
	width="729"
	height="134"
	srcset="/post/mysql-replication-1/img_13_hu470b6264dd1d91f0c5c448750f2ccd10_7269_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_13_hu470b6264dd1d91f0c5c448750f2ccd10_7269_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="544"
		data-flex-basis="1305px"
	
></p>
<p>设置<code>slave_parallel_workers=2</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; <span class="nb">set</span> @@global.slave_parallel_workers<span class="o">=</span>2<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; stop slave sql_thread<span class="p">;</span>
</span></span><span class="line"><span class="cl">msyql&gt; start slave sql_thread<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; show full processlist<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/mysql-replication-1/img_14.png"
	width="770"
	height="173"
	srcset="/post/mysql-replication-1/img_14_hue942e247f00f22095baed0e1f57ccf1f_10974_480x0_resize_box_3.png 480w, /post/mysql-replication-1/img_14_hue942e247f00f22095baed0e1f57ccf1f_10974_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="445"
		data-flex-basis="1068px"
	
></p>
<p>可见多出了两个线程，其状态信息是&quot;Waiting for an event from Coordinator&quot;。</p>
<p>虽然是多个SQL线程，但是复制时每个库只能使用一个线程(默认情况下，可以通过<code>--slave-parallel-type</code>修改并行策略)，因为如果一个库可以使用多个线程，多个线程并行重放relay log，可能导致数据错乱。所以应该设置线程数等于或小于要复制的库的数量，设置多了无效且浪费资源。</p>
<h4 id="多线程复制带来的不一致问题">多线程复制带来的不一致问题</h4>
<p>虽然多线程复制带来了一定的复制性能提升，但它也带来了很多问题，最严重的是一致性问题。完整的内容见<a class="link" href="https://dev.mysql.com/doc/refman/8.0/en/replication-features-transaction-inconsistencies.html"  target="_blank" rel="noopener"
    >官方手册</a>。此处介绍其中一个最重要的问题。</p>
<p><strong>关于多线程复制，最常见也是开启多线程复制前最需要深入了解的问题是：由于多个SQL线程同时执行relay log中的事务，这使得slave上提交事务的顺序很可能和master binlog中记录的顺序不一致(除非指定变量<code>slave_preserve_commit_order=1</code>)。</strong> (注意：这里说的是事务而不是事件。因为MyISAM的binlog顺序无所谓，只要执行完了就正确，而且多线程协调器能够协调好这些任务。所以只需考虑innodb基于事务的binlog)</p>
<p>举个简单的例子，master上事务A先于事务B提交，到了slave上因为多SQL线程的原因，可能事务B提交了事务A却还没提交。</p>
<p>是否还记得<code>show slave status</code>中的<code>Exec_master_log_pos</code>代表的意义？它表示SQL线程最近执行的事件对应的是master binlog中的哪个位置。问题由此而来。通过<code>show slave status</code>，我们看到已经执行事件对应的坐标，它前面可能还有事务没有执行。而在relay log中，事务B记录的位置是在事务A之后的(和master一样)，于是事务A和事务B之间可能就存在一个孔洞(gap)，这个孔洞是事务A剩余要执行的操作。</p>
<p>正常情况下，多线程协调器记录了一切和多线程复制相关的内容，它能识别这种孔洞(通过打低水位标记low-watermark)，也能正确填充孔洞。<strong>即使是在存在孔洞的情况下执行<code>stop slave</code>也不会有任何问题，因为在停止SQL线程之前，它会等待先把孔洞填充完。</strong> 但危险因素太多，比如突然宕机、突然杀掉mysqld进程等等，这些都会导致孔洞持续下去，甚至可能因为操作不当而永久丢失这部分孔洞。</p>
<p>那么如何避免这种问题，出现这种问题如何解决？</p>
<p><strong>1、如何避免gap。</strong></p>
<p>前面说了，多个SQL线程是通过协调器来调度的。默认情况下，可能会出现gap的情况，这是因为变量<code>slave_preserve_commit_order</code>的默认值为0。该变量指示协调器是否让每个SQL线程执行的事务按master binlog中的顺序提交。因此，将其设置为1，然后重启SQL线程即可保证SQL线程按序提交，也就不可能会有gap的出现。</p>
<p>当事务B准备先于事务A提交的时候，它将一直等待。此时slave的状态将显示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Waiting <span class="k">for</span> preceding transaction to commit   <span class="c1"># MySQL 5.7.8之后显示该状态</span>
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> its turn to commit       <span class="c1"># MySQL 5.7.8之前显示该状态</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>尽管不会出现gap，但<code>show slave status</code>的<code>Exec_master_log_pos</code>仍可能显示在事务A的坐标之后。</p>
<p>由于开启<code>slave_preserve_commit_order</code>涉及到不少操作，它还要求开启slave的<code>binlog--log-bin</code>(因此需要重启mysqld)，且开启重放relay log也记录binlog的行为<code>--log-slave-updates</code>，此外，还必须设置多线程的并行策略<code>--slave-parallel-type=LOGICAL_CLOCK</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">shell&gt; mysqladmin -uroot -p shutdown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">shell&gt; cat /etc/my.cnf
</span></span><span class="line"><span class="cl"><span class="nv">log_bin</span><span class="o">=</span>slave-bin
</span></span><span class="line"><span class="cl">log-slave-updates
</span></span><span class="line"><span class="cl"><span class="nv">slave_parallel_workers</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">slave_parallel_type</span><span class="o">=</span>LOGICAL_CLOCK
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">shell&gt;service mysqld start
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2、如何处理已经存在的gap。</strong></p>
<p>方法之一，是从master上重新备份恢复到slave上，这种方法是处理不当的最后解决办法。</p>
<p>正常的处理方法是，使用<code>START SLAVE [SQL_THREAD] UNTIL SQL_AFTER_MTS_GAPS;</code>，它表示SQL线程只有先填充gaps后才能启动。实际上，它涉及了两个操作：</p>
<ol>
<li>填充gaps</li>
<li>自动停止SQL线程(所以之后需要手动启动SQL线程)</li>
</ol>
<p>一般来说，在填充完gaps之后，应该先<code>reset slave</code>移除已经执行完的relay log，然后再去启动sql_thread。</p>
<h4 id="多线程复制切换回单线程复制">多线程复制切换回单线程复制</h4>
<p>多线程的带来的问题不止gaps一种，所以没有深入了解多线程的情况下，千万不能在生产环境中启用它。如果想将多线程切换回单线程，可以执行如下操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">START SLAVE UNTIL SQL_AFTER_MTS_GAPS<span class="p">;</span>
</span></span><span class="line"><span class="cl">SET @@GLOBAL.slave_parallel_workers <span class="o">=</span> 0<span class="p">;</span>
</span></span><span class="line"><span class="cl">START SLAVE SQL_THREAD<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="slave升级为master的大致操作">slave升级为master的大致操作</h3>
<p>当master突然宕机，有时候需要切换到slave，将slave提升为新的master。但对于master突然宕机可能造成的数据丢失，主从切换是无法解决的，它只是尽可能地不间断提供MySQL服务。</p>
<p>假如现在有主服务器M，从服务器S1、S2，S1作为将来的新的master。</p>
<p>1、在将S1提升为master之前，需要保证S1已经将relay log中的事件已经replay完成。即下面两个状态查看语句中SQL线程的状态显示为：&ldquo;Slave has read all relay log; waiting for the slave I/O thread to update it&rdquo;。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">show slave status<span class="p">;</span>
</span></span><span class="line"><span class="cl">show processlist<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2、停止S1上的IO线程和SQL线程，然后将S1的binlog清空(要求已启用binlog)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; stop slave<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; reset master<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3、在S2上停止IO线程和SQL线程，通过<code>change master to</code>修改master的指向为S1，然后再启动io线程和SQL线程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; stop slave<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; change master to <span class="nv">master_host</span><span class="o">=</span>S1,...
</span></span><span class="line"><span class="cl">mysql&gt; start slave<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4、将应用程序原本指向M的请求修改为指向S1，如修改MySQL代理的目标地址。一般会通过MySQL Router、Amoeba、cobar等数据库中间件来实现。</p>
<p>5、删除S1上的master.info、relay-log.info文件，否则下次S1重启服务器会继续以slave角色运行。</p>
<p>6、将来M重新上线后，可以将其配置成S1的slave，然后修改应用程序请求的目标列表，添加上新上线的M，如将M加入到MySQL代理的读目标列表。</p>
<p>注意：<code>reset master</code>很重要，如果不是基于GTID复制且开启了<code>log-slave-updates</code>选项时，S1在应用relay log的时候会将其写入到自己的binlog，以后S2会复制这些日志导致重复执行的问题。</p>
<p>其实上面只是提供一种slave升级为Master的解决思路，在实际应用中环境可能比较复杂。例如，上面的S1是S2的master，这时S1如果没有设置为read-only，当M宕机时，可以不用停止S1，也不需要<code>reset master</code>等操作，受影响的操作仅仅只是S1一直无法连接M而已，但这对业务不会有多大的影响。</p>
<p>相信理解了前面的内容，分析主从切换的思路应该也没有多大问题。</p>
<h3 id="指定不复制到slave上的语句">指定不复制到slave上的语句</h3>
<p>前面说的筛选要复制的库和表可以用于指定不复制到slave上的库和表，但却没有筛选不复制到slave的语句。</p>
<p>但有些特殊情况下，可能需要这种功能。例如，master上创建专门用于复制的用户repl，这种语句其实没有必要复制到slave上，甚至出于安全的考虑不应该复制到slave上。</p>
<p>可以使用<code>sql_log_bin</code>变量对此进行设置，默认该变量的值为1，表示所有语句都写进binlog，从而被slave复制走。如果设置为0，则之后的语句不会写入binlog，从而实现&quot;不复制某些语句到slave&quot;上的功能。</p>
<p>例如：屏蔽创建repl用户的语句。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mysql&gt; <span class="nb">set</span> <span class="nv">sql_log_bin</span><span class="o">=</span>0<span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; create user repl@<span class="s1">&#39;%&#39;</span> identified by <span class="s1">&#39;P@ssword1!&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; grant replication slave on *.* to repl@<span class="s1">&#39;%&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">mysql&gt; <span class="nb">set</span> <span class="nv">sql_log_bin</span><span class="o">=</span>1<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在使用该变量时，默认是会话范围内的变量，一定不能设置它的全局变量值，否则所有语句都将不写binlog。</p>
<h3 id="主从高延迟的解决思路">主从高延迟的解决思路</h3>
<p>slave通过IO线程获取master的binlog，并通过SQL线程来应用获取到的日志。因为各个方面的原因，经常会出现slave的延迟(即<code>Seconds_Behind_Master</code>的值)非常高(动辄几天的延迟是常见的，几个小时的延迟已经算短的)，使得主从状态不一致。</p>
<p>一个很容易理解的延迟示例是：假如master串行执行一个大事务需要30分钟，那么slave应用这个事务也大约要30分钟，从master提交的那一刻开始，slave的延迟就是30分钟，更极端一点，由于binlog的记录时间点是在事务提交时，如果这个大事务的日志量很大，比如要传输10多分钟，那么很可能延迟要达到40分钟左右。而且更严重的是，这种延迟具有滚雪球的特性，从延迟开始，很容易导致后续加剧延迟。</p>
<p>所以，第一个优化方式是不要在mysql中使用大事务，这是mysql主从优化的第一口诀。</p>
<p>在回归正题，要解决slave的高延迟问题，先要知道<code>Second_Behind_Master</code>是如何计算延迟的：SQL线程比IO线程慢多少(其本质是NOW()减去<code>Exec_Master_Log_Pos</code>处设置的TIMESTAMP)。在主从网络状态良好的情况下，IO线程和master的binlog大多数时候都能保持一致(也即是IO线程没有多少延迟，除非事务非常大，导致二进制日志传输时间久，<strong>但mysql优化的一个最基本口诀就是大事务切成小事务)</strong>，所以在这种理想状态下，可以认为主从延迟说的是slave上的数据状态比master要延迟多少。它的计数单位是秒。</p>
<ol>
<li>
<p><strong>从产生Binlog的master上考虑，可以在master上应用group commit的功能，并设置参数<code>binlog_group_commit_sync_delay</code>和<code>bin log_group_commit_sync_no_delay_count</code>，前者表示延迟多少秒才提交事务，后者表示要堆积多少个事务之后再提交。这样一来，事务的产生速度降低，slave的SQL线程相对就得到缓解。</strong></p>
</li>
<li>
<p><strong>再者从slave上考虑，可以在slave上开启多线程复制(MTS)功能，让多个SQL线程同时从一个IO线程中取事务进行应用，这对于多核CPU来说是非常有效的手段。</strong> 但是前面介绍多线程复制的时候说过，没有掌握多线程复制的方方面面之前，千万不要在生产环境中使用多线程复制，要是出现gap问题，很让人崩溃。</p>
</li>
<li>
<p>最后从架构上考虑。主从延迟是因为slave跟不上master的速度，那么可以考虑对master进行节流控制，让master的性能下降，从而变相提高slave的能力。这种方法肯定是没人用的，但确实是一种方法，提供了一种思路，比如slave使用性能比master更好的硬件。另一种比较可取的方式是加多个中间slave层(也就是master-&gt;slaves-&gt;slaves)，让多个中间slave层专注于复制(也可作为非业务的他用，比如用于备份)。</p>
</li>
<li>
<p>使用组复制或者Galera/PXC的多写节点，此外还可以设置相关参数，让它们对延迟自行调整。但一般都不需要调整，因为有默认设置。</p>
</li>
</ol>
<p>还有比较细致的方面可以降低延迟，比如设置为row格式的Binlog要比statement要好，因为不需要额外执行语句，直接修改数据即可。比如master设置保证数据一致性的日志刷盘规则(sync_binlog/innodb_flush_log_at_trx_commit设置为1)，而slave关闭binlog或者设置性能优先于数据一致性的binlog刷盘规则。再比如设置slave的隔离级别使得slave的锁粒度放大，不会轻易锁表(多线程复制时避免使用此方法)。还有很多方面，选择好的磁盘，设计好分库分表的结构等等，这些都是直接全局的，实在没什么必要在这里多做解释。</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/mysql/">mysql</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span> 转载需要保留原始链接，未经明确许可，禁止商业使用。  <a class="link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"  target="_blank" rel="noopener"
    >CC BY-NC-SA 4.0</a></span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/post/mysql-replication-2/">
        
        

        <div class="article-details">
            <h2 class="article-title">深入MySQL复制(二)：基于GTID复制 </h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/mysql-general-log/">
        
        

        <div class="article-details">
            <h2 class="article-title">mysql general_log</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/mysql-cluster/">
        
        

        <div class="article-details">
            <h2 class="article-title">MySQL主从同步集群搭建</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div id="gitalk-container"></div>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"
/>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: "5b878f724ec8e67e08f4",
        clientSecret: "9723d7c9b9644be68bf47cbdd6412bc895653369",
        repo: "arturiamu.github.io",
        owner: "arturiamu",
        admin: ["arturiamu"],
        distractionFreeMode: false, 
        id: md5(location.pathname), 
    });
    (function () {
        if (
            ["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1
        ) {
            document.getElementById("gitalk-container").innerHTML =
                "Gitalk comments not available by default when the website is previewed locally.";
            return;
        }
        gitalk.render("gitalk-container");
    })();
</script>



    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2023 木林彪的个人博客
    </section>

    <section class="count_info">
        <div>
            本博客已稳定运行
            <span id="ds" class="running-days"></span>
            天
            <span id="hs" class="running-days"></span>
            小时
            <span id="ms" class="running-days"></span>
            分钟
        </div>
        <div>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            共发表 23 篇文章 · 总计 63.51 k 字
        </div>
        <div>
            <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
        </div>
    </section>
    
    <section class="powerby" style="margin-top: 7px">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.18.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


<script>
    let s1 = '2023-6-18'; 
    s1 = new Date(s1.replace(/-/g, "/"));
    let s2 = new Date();
    let timeDifference = s2.getTime() - s1.getTime();

    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));
    document.getElementById('ds').innerHTML = days;
    document.getElementById('hs').innerHTML = hours;
    document.getElementById('ms').innerHTML = minutes;

</script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>
    (function(u, c) {
        var d = document, t = 'script', o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function(e) { c(e); }); }
        s.parentNode.insertBefore(o, s);
    })('//cdn.bootcss.com/pangu/4.0.7/pangu.min.js', function() {
        pangu.spacingPage();
    });
</script>


<script
        src="https://cdn.jsdelivr.net/gh/zhixuan2333/gh-blog@v0.1.0/js/ribbon.min.js"
        integrity="sha384-UEK8ZiP3VgFNP8KnKMKDmd4pAUAOJ59Y2Jo3ED2Z5qKQf6HLHovMxq7Beb9CLPUe"
        crossorigin="anonymous"
        size="300"
        alpha="0.6"
        zindex="-1"
        defer
></script>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script><script>
    (function(){var w=window;if(w.ChannelIO){return w.console.error("ChannelIO script included twice.");}var ch=function(){ch.c(arguments);};ch.q=[];ch.c=function(args){ch.q.push(args);};w.ChannelIO=ch;function l(){if(w.ChannelIOInitialized){return;}w.ChannelIOInitialized=true;var s=document.createElement("script");s.type="text/javascript";s.async=true;s.src="https://cdn.channel.io/plugin/ch-plugin-web.js";var x=document.getElementsByTagName("script")[0];if(x.parentNode){x.parentNode.insertBefore(s,x);}}if(document.readyState==="complete"){l();}else{w.addEventListener("DOMContentLoaded",l);w.addEventListener("load",l);}})();

    ChannelIO('boot', {
        "pluginKey": "6145a739-ffa9-4356-8e35-875010c793ef"
    });
</script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
